% Copyright 2021-2022 Bas van Meerten and Wouter Franssen
%
%This file is part of magpie.
%
%magpie is free software: you can redistribute it and/or modify
%it under the terms of the GNU General Public License as published by
%the Free Software Foundation, either version 3 of the License, or
%(at your option) any later version.
%
%magpie is distributed in the hope that it will be useful,
%but WITHOUT ANY WARRANTY; without even the implied warranty of
%MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%GNU General Public License for more details.
%
%You should have received a copy of the GNU General Public License
%along with magpie. If not, see <http://www.gnu.org/licenses/>.

\documentclass[11pt,a4paper]{article}
\include{DeStijl}

\usepackage[bitstream-charter]{mathdesign}
\usepackage[T1]{fontenc}
\usepackage[protrusion=true,expansion,tracking=true]{microtype}
\pgfplotsset{compat=1.7,/pgf/number format/1000 sep={}, axis lines*=left,axis line style={gray},every outer x axis line/.append style={-stealth'},every outer y axis line/.append style={-stealth'},tick label style={font=\small},label style={font=\small},legend style={font=\footnotesize}}
\usepackage{colortbl}
\usepackage{listings}


%Set section font
\usepackage{sectsty}
\allsectionsfont{\color{black!70}\fontfamily{SourceSansPro-LF}\selectfont}
%--------------------


%Set toc fonts
\usepackage{tocloft}
%\renewcommand\cftchapfont{\fontfamily{SourceSansPro-LF}\bfseries}
\renewcommand\cfttoctitlefont{\color{black!70}\Huge\fontfamily{SourceSansPro-LF}\bfseries}
\renewcommand\cftsecfont{\fontfamily{SourceSansPro-LF}\selectfont}
%\renewcommand\cftchappagefont{\fontfamily{SourceSansPro-LF}\bfseries}
\renewcommand\cftsecpagefont{\fontfamily{SourceSansPro-LF}\selectfont}
\renewcommand\cftsubsecfont{\fontfamily{SourceSansPro-LF}\selectfont}
\renewcommand\cftsubsecpagefont{\fontfamily{SourceSansPro-LF}\selectfont}
%--------------------

%Define header/foot
\usepackage{fancyhdr}
\pagestyle{fancy}
\fancyhead[LE,RO]{\fontfamily{SourceSansPro-LF}\selectfont \thepage}
\fancyhead[LO,RE]{\fontfamily{SourceSansPro-LF}\selectfont \leftmark}
\fancyfoot[C]{}
%--------------------

%remove page number from first chapter page
\makeatletter
\let\ps@plain\ps@empty
\makeatother
%----------------------
\usepackage{blindtext, color}
\definecolor{gray75}{gray}{0.75}
\newcommand{\hsp}{\hspace{20pt}}



\usepackage[hidelinks,colorlinks,allcolors=blue, pdftitle={The Magpie manual},pdfauthor={W.M.J.\ Franssen}]{hyperref}

\interfootnotelinepenalty=10000 %prevents splitting of footnote over multiple pages
\linespread{1.2}

%\usepgfplotslibrary{external}%creates all external tikz images that are included.
%\tikzexternalize[shell escape=-enable-write18]%activate externalization
%\tikzsetexternalprefix{GeneratedFigures/}
%\tikzset{external/force remake} %Enable forced remake



\begin{document}
%\newgeometry{left=72pt,right=72pt,top=95pt,bottom=95pt,footnotesep=0.5cm}
\input{Title.tex}

\thispagestyle{empty}
\newpage
\mbox{}

%\restoregeometry

\pagenumbering{roman}
%\pagestyle{empty}
\renewcommand\cfttoctitlefont{\color{black}\Huge\fontfamily{SourceSansPro-LF}\bfseries}
\microtypesetup{protrusion=false} % disables protrusion locally in the document
\setcounter{tocdepth}{2}
\tableofcontents % prints Table of Contents
\microtypesetup{protrusion=true} % enables protrusion
\addtocontents{toc}{\protect\thispagestyle{empty}}
%\pagestyle{plain}

\renewcommand\cfttoctitlefont{\color{black!70}\Huge\fontfamily{SourceSansPro-LF}\bfseries}


\pagenumbering{arabic}
\section{Introduction}
Magpie (waar staat het voor?) is a program that simualtes an NMR spectrometer environment. It can load sample and pulse sequences, and simulate the outcome of NMR measurements. The goal of the program is to be used in teaching, allowing students a first introduction to practical NMR.

\section{Interface}

The Magpie interface looks like this:
\begin{center}
\includegraphics[width=0.7\linewidth]{images/Full_interface.png}
\end{center}
In the sections below, the individual elements are explained.

\subsection{Spectrometer settings}


\begin{center}
\includegraphics[width=0.3\linewidth]{images/Spec_settings.png}
\end{center}
In the left of the Magpie screen, the spectrometer settings can be put in. These are all settings that are not specific to a pulse sequence. Also, the buttons to load a sample and a pulse sequence are contained here. Below is a list of the settings and their description.

\begin{itemize}
\item \textbf{Load sample:} Opens a file dialog to brows for a sample file. More info can be found in \autoref{sec:sample}. The file should have extension \texttt{.txt}.
\item \textbf{Load pulse sequence:} Opens a file dialog to brows for a pulse sequence file file. More info can be found in \autoref{sec:pulseseq}. The file should have extension \texttt{.csv}.
\item \textbf{Detect:} The nucleus to detect. In principle, any nucleus can be detected. For the moment, we limit the selection to $^1$H and $^{13}$C though. This is a design choice to not overflow the user with obscure nuclei.
\item \textbf{Decouple:} The nucleus that is decoupled during a decoupling pulse sequence element. Only active if the pulse sequence has a decouple element.
\item \textbf{B$_\mathbf{0}$:} The main magnetic field strength in Tesla. Magpie supports any magnetic field strength. For now, we decide on using a dropdown box with only common fields. This is the teach the user that in reality the magnetic field cannot easily be changed to whatever we want.
\item \textbf{Offset [kHz]:} The transmitter offset in kHz. This can be used to fine-tune the center frequency of the experiment. It defines the center of the spectrum, as well as the frequecy on which any pulses are given.
\item \textbf{Gain:} The gain factor of the receiver. All signals are multiplied by this value before detection. Note that, contrary to most real-life spectrometers, Magpie uses a linear scale, and does not work in dB.
\item \textbf{\# Scans:} The number of individual scans that need to be recorded. All scans are automatically summed.
\end{itemize}

\subsection{Pulse sequence settings}\label{sec:seq_settings}

\begin{center}
\includegraphics[width=0.9\linewidth]{images/Sequence_settings.png}
\end{center}
In the bottom of the Magpie interface, the pulse sequence settings are defined. Each tab represent a separate element of the pulse sequence. The names of the tabs are equal to the names of the elements, as defined in the pulse sequence file. The pulse sequence diagram (in the plot window) always highlights the element which settings tab is currently showing. More info on pulse sequences, and the relevant settings per element can be found in \autoref{sec:pulseseq}.

\subsection{Plot windows}
The plot window contains three tabs: Pulse sequence, FID, and Spectrum. These are explained below.
\subsubsection{Pulse sequence}
\begin{center}
\includegraphics[width=0.9\linewidth]{images/Plot_sequence.png}
\end{center}
The pulse sequence tab displays a diagram of the current pulse sequence. The current element that is selected is displayed in red. Left-clicking on an element changes the selection. The sequence settings tab (see \autoref{sec:seq_settings}) folows this selection (and vice-versa).

The labels displayed above the sequence elements are those as defined in the pulse sequence file. The tabs in the sequence settings window also have this name.

The elements in the pulse sequence each have a unique pictorial representation. The style of the elements is not updated depending on the pulse sequence settings (e.g.\ a pulse with amplitude 0 is not shown as a much lower rectangle).


\subsubsection{FID}
\begin{center}
\includegraphics[width=0.9\linewidth]{images/Plot_FID.png}
\end{center}

\subsubsection{Spectrum}
\begin{center}
\includegraphics[width=0.9\linewidth]{images/Plot_Spectrum.png}
\end{center}


\section{Sample definition}\label{sec:sample}
Sample files for Magpie need to be in a specific definition. They need to be text files with \texttt{.txt} extension.

The file should start with a header:
\begin{verbatim}
###SAMPLE###
\end{verbatim}
Below this, on optional statement regarding the sample amount (concentration) can be made:

\begin{verbatim}
amount 1 
\end{verbatim}
In this case, the scaling is set to \texttt{1}, so it has no effect.

After this, a molecule can be defined. The sample file can hold multiple molecule definitions. Within this block, the spins are set, as well as the overall relaxation times and the J-couplings.

The statements are:

\begin{center}
\begin{tabular}{lp{5cm}p{6cm}}
\toprule
\textbf{Statement} & \textbf{Input} & \textbf{Description} \\
\midrule
\rowcolor{gray!30!white}
\texttt{amount} & amount & molecule amount\\
\texttt{T1} & T1 & Overall T1, in seconds (optional)\\
\rowcolor{gray!30!white}
\texttt{T2} & T2 & Overall T2, in seconds (optional)\\
\texttt{T2prime} & T2prime & Overall T2prime, in seconds (optional)\\
\rowcolor{gray!30!white}
\texttt{spin} & isotope shift multiplicity & For example: \texttt{1H 1.2 3}\\
\texttt{spin} & isotope shift multiplicity T1 T2 T2prime & Spin definition including relation times. These are used in favour of the overall relaxation times, if set. Values can be set empty by an underscore (\_) \\
\rowcolor{gray!30!white}
\texttt{J} & spin1 spin2 strength & Set J-coupling in Hz between two spin indexes. Number order as the spins are defined. For example: \texttt{J 1 2 9.6}\\
\texttt{Jmatrix} & matrix & Set J-coupling in Hz between all spins in matrix format. Example for two spins: \texttt{[[0,10],[10,0]]}, setting 10 Hz coupling. Size needs to be n\_spins x n\_spins. When used the, regular \texttt{J} statement cannot be used.\\
\rowcolor{gray!30!white}
pair & isotope shift1 shift2 k amp1 amp2 T1\_1 T1\_2 T2\_1 T2\_2 &  Sets a spin-pair with exchange between them. \texttt{amp} sets the multiplicity. Individual T1 and T2 times can be set, or set to empty by an underscore (\_). No J-couplings can be set to these spins.\\
\bottomrule
\end{tabular}
\end{center}

Either \texttt{Jmatrix} or \texttt{J} statements are allowed. Not both.
Spin statements can lack all the relaxation times, or have a \_ instead.
If a relax time not defined for a spin, it needs to use the global molecule relaxation time.
These are also optional, but if they lack, the individual spin lifetimes need to be all there.

An example definition could be the following sample:
\begin{verbatim}
###SAMPLE###
amount 1
###MOLECULE###
amount 0.1
T1 5
T2 0.5
T2prime 10
spin 1H 1.2 3
spin 1H 3.6 2
J 1 2 7
\end{verbatim}
Here we set a two spin system, with shifts 1.2 and 3.6 ppm, multiplicities 3 and 2. There is a 7 Hz J-coupling between the spins. All nuclei have the same relaxation times, set at 5, 0.5 and 10 s for T1, T2 and T2prime respectively. The overall intensity scaling is set at 1, and the molecule itself has scaling 0.1.

A more complicated sample could be ethanol:
\begin{verbatim}
###SAMPLE###
amount 1
###MOLECULE###
amount 0.98 
T1 5
T2 0.5
T2prime 10
spin 1H 1.226 3
spin 1H 3.692 2
spin 1H 2.605 1 _ 0.01 0.1
J 1 2 7
###MOLECULE###
amount 0.01 
T1 5
T2 1
T2prime 10
spin 1H 1.224 3
spin 1H 3.692 2
spin 1H 2.605 1 _ 0.01 0.1
spin 13C 18.1 1 _ _ 7
J 1 2 7
J 1 4 125
###MOLECULE###
amount 0.01 
T1 7
T2 1
T2prime 10
spin 1H 1.226 3
spin 1H 3.692 2
spin 1H 2.605 1 _ 0.01 0.1
spin 13C 57.8 1 _ _ 7
J 1 2 7
J 2 4 125
\end{verbatim}
Here we set three molecules: with no 13C nucleus, and both options with a single 13C nucleus (the 13C-13C variant is too low in intensity to care about). The amount of the molecules is set to follow the natural abundance. For the OH peak (at 2.6 ppm), a separate set of relaxation times is set, as to have a shorter T2 and T2prime, to include the fact that this signal is usually exchanging causing line broadening. J-couplings are ste between the 1H nuclei of the CH$_3$ and CH$_2$ groups, as well as between the 13C nuclei and their directly bonded 1H nuclei. 

\section{Pulse sequence definition}\label{sec:pulseseq}

\section{Data output}

\section{Simulation background}
Magpie uses a classical simulator, so no quantum effects are included. J-couplings are therefore included only as their weak coup;ling limit, and no coherence between the J-states exists.



\section{Contact}
To contact the \texttt{magpie} team write to \texttt{ssnake@science.ru.nl}.

\bibliographystyle{BibStyle}
\bibliography{ReferenceManual}

\end{document}
